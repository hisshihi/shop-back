import{d as ee,u as M,r as g,_ as L,c as n,a as e,t as _,b as F,F as E,e as j,n as U,w as Q,v as H,f as te,o,g as I,h as se,i as $,j as q,k as ae,l as oe,m as ne,p as ie,q as re,s as J,x as le,y as ce,z as ue,A as ve,B as de}from"./index-Bb9AnJlj.js";const O=ee("review",()=>{const b=M(),S=g([]),l=g(0),C=g(0),r=g(!1),m=g(null),u=g({});function k(){S.value=[],l.value=0,C.value=0,m.value=null}async function p(v,d=1,s=5){if(!v)return{success:!1,error:"Не указан ID товара"};r.value=!0,m.value=null,k();try{const a=await fetch(`http://localhost:8080/api/v1/review/list?product_id=${v}&page_id=${d}&page_size=${s}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok){const y=await a.json();throw new Error(y.error||"Не удалось загрузить отзывы")}const f=await a.json();if(console.log("Получены данные отзывов:",f),S.value=f.review_list||[],l.value=f.count_review||0,f.average&&f.average.avearage_rating&&f.average.avearage_rating.Valid){const y=parseFloat(f.average.avearage_rating.String);C.value=isNaN(y)?0:y}else C.value=0;return console.log("Обработанный средний рейтинг:",C.value),{success:!0}}catch(a){return m.value=a.message,console.error("Ошибка при загрузке отзывов:",a),{success:!1,error:a.message}}finally{r.value=!1}}async function x(v){if(!b.isAuthenticated)return{canReview:!1,reason:"Необходимо авторизоваться"};if(!v)return{canReview:!1,reason:"Не указан ID товара"};try{if(u.value[v]===!1)return{canReview:!1,reason:"Можно оставлять отзывы только на товары, которые вы приобрели"};if(u.value[v]===void 0){const s=await fetch(`http://localhost:8080/api/v1/review/list?product_id=${v}&page_id=1&page_size=5`,{method:"GET",headers:{Authorization:`Bearer ${b.token}`,"Content-Type":"application/json"}});if(!s.ok){const a=await s.json();if(s.status===403)return u.value[v]=!1,{canReview:!1,reason:a.error||"Можно оставлять отзывы только на товары, которые вы приобрели"};throw new Error(a.error||"Ошибка при проверке возможности оставить отзыв")}u.value[v]=!0}const d=S.value.find(s=>s.user_id===b.user.id);return d?{canReview:!1,reason:"Вы уже оставили отзыв на этот товар",reviewId:d.id}:{canReview:!0}}catch(d){return console.error("Ошибка при проверке возможности оставить отзыв:",d),{canReview:!1,reason:d.message||"Не удалось проверить возможность оставить отзыв"}}}async function t(v,d,s=""){if(!b.isAuthenticated)return{success:!1,error:"Необходимо авторизоваться"};r.value=!0,m.value=null;try{const a=await fetch("http://localhost:8080/api/v1/review",{method:"POST",headers:{Authorization:`Bearer ${b.token}`,"Content-Type":"application/json"},body:JSON.stringify({product_id:v,rating:d,comment:s})});if(!a.ok){const y=await a.json();throw new Error(y.error||"Не удалось добавить отзыв")}const f=await a.json();return await p(v),{success:!0,review:f}}catch(a){return m.value=a.message,console.error("Ошибка при добавлении отзыва:",a),{success:!1,error:a.message}}finally{r.value=!1}}async function T(v,d,s=""){if(!b.isAuthenticated)return{success:!1,error:"Необходимо авторизоваться"};r.value=!0,m.value=null;try{const a=await fetch(`http://localhost:8080/api/v1/review/${v}`,{method:"PUT",headers:{Authorization:`Bearer ${b.token}`,"Content-Type":"application/json"},body:JSON.stringify({rating:d,comment:s})});if(!a.ok){const D=await a.json();throw new Error(D.error||"Не удалось обновить отзыв")}const f=await a.json(),y=f.product_id;return await p(y),{success:!0,review:f}}catch(a){return m.value=a.message,console.error("Ошибка при обновлении отзыва:",a),{success:!1,error:a.message}}finally{r.value=!1}}async function P(v,d){if(!b.isAuthenticated)return{success:!1,error:"Необходимо авторизоваться"};r.value=!0,m.value=null;try{const s=await fetch(`http://localhost:8080/api/v1/review/${v}`,{method:"DELETE",headers:{Authorization:`Bearer ${b.token}`}});if(!s.ok){const a=await s.json();throw new Error(a.error||"Не удалось удалить отзыв")}return await p(d),{success:!0}}catch(s){return m.value=s.message,console.error("Ошибка при удалении отзыва:",s),{success:!1,error:s.message}}finally{r.value=!1}}return{reviews:S,totalReviews:l,averageRating:C,loading:r,error:m,fetchReviewsByProductId:p,checkCanReview:x,addReview:t,updateReview:T,deleteReview:P}}),fe={class:"review-form"},we={class:"form-title"},he={class:"rating-container"},pe={class:"stars-container"},_e=["onClick"],ge={class:"rating-text"},me={class:"form-group"},ye={key:0,class:"error-message"},be={class:"form-actions"},ke=["disabled"],Re=["disabled"],$e={__name:"ReviewForm",props:{productId:{type:Number,required:!0},existingReview:{type:Object,default:null}},emits:["review-submitted","review-updated","cancel"],setup(b,{emit:S}){const l=b,C=S,r=O(),m=s=>s&&typeof s=="object"&&s.Valid?s.String:"",u=g(l.existingReview?l.existingReview.rating:3),k=g(l.existingReview?m(l.existingReview.comment):""),p=g(!1),x=g(null),t=g(!!l.existingReview),T={1:"Ужасно",2:"Плохо",3:"Нормально",4:"Хорошо",5:"Отлично"};function P(s){u.value=s}async function v(){if(x.value=null,u.value<1||u.value>5){x.value="Пожалуйста, выберите оценку от 1 до 5";return}p.value=!0;try{let s;t.value&&l.existingReview?(s=await r.updateReview(l.existingReview.id,u.value,k.value),s.success&&C("review-updated",s.review)):(s=await r.addReview(l.productId,u.value,k.value),s.success&&C("review-submitted",s.review)),s.success||(x.value=s.error||"Произошла ошибка при отправке отзыва")}catch(s){console.error("Ошибка при отправке отзыва:",s),x.value="Произошла ошибка при отправке отзыва"}finally{p.value=!1}}function d(){C("cancel")}return(s,a)=>(o(),n("div",fe,[e("h3",we,_(t.value?"Редактировать отзыв":"Оставить отзыв"),1),e("form",{onSubmit:te(v,["prevent"])},[e("div",he,[a[1]||(a[1]=e("p",{class:"rating-label"},"Ваша оценка:",-1)),e("div",pe,[(o(),n(E,null,j(5,f=>e("button",{key:f,type:"button",class:U(["star-btn",{selected:u.value>=f}]),onClick:y=>P(f)},"★",10,_e)),64))]),e("span",ge,_(T[u.value]),1)]),e("div",me,[a[2]||(a[2]=e("label",{for:"comment",class:"form-label"},"Ваш комментарий (необязательно):",-1)),Q(e("textarea",{id:"comment","onUpdate:modelValue":a[0]||(a[0]=f=>k.value=f),class:"form-input",placeholder:"Напишите ваше мнение о товаре",rows:"4"},null,512),[[H,k.value]])]),x.value?(o(),n("div",ye,_(x.value),1)):F("",!0),e("div",be,[e("button",{type:"submit",class:"btn btn-accent",disabled:p.value},_(p.value?"Отправка...":t.value?"Обновить отзыв":"Отправить отзыв"),9,ke),e("button",{type:"button",class:"btn btn-outline",onClick:d,disabled:p.value}," Отмена ",8,Re)])],32)]))}},Ce=L($e,[["__scopeId","data-v-5ffd8ce8"]]),xe={class:"reviews-section"},Se={key:0,class:"loading-container"},Pe={key:1,class:"error-message"},Ve={key:2},Ae={class:"reviews-header"},Fe={key:0,class:"reviews-summary"},Te={class:"average-rating"},De={class:"reviews-count"},Ie={key:1,class:"no-reviews-summary"},Ee={key:0,class:"no-reviews"},je={key:1,class:"reviews-list"},Be={class:"review-header"},Ne={class:"reviewer-info"},ze={class:"reviewer-name"},qe={class:"review-date"},Me={class:"review-content"},Le={key:0,class:"review-comment"},Ue={key:1,class:"review-no-comment"},Oe={key:0,class:"review-actions"},Ge=["onClick"],Je=["onClick"],Qe={key:2,class:"pagination reviews-pagination"},He=["disabled"],Ke={class:"pagination-pages"},We=["onClick"],Xe=["disabled"],Ye={__name:"ReviewList",props:{productId:{type:Number,required:!0}},emits:["edit-review","delete-review"],setup(b,{emit:S}){const l=b,C=S,r=O(),m=M(),u=g(1),k=g(5),p=I(()=>Math.ceil(r.totalReviews/k.value)||1),x=I(()=>{const i=p.value;if(i<=5)return Array.from({length:i},(A,N)=>N+1);const h=[];h.push(1);let w=Math.max(2,u.value-1),V=Math.min(i-1,u.value+1);w>2&&h.push("...");for(let A=w;A<=V;A++)h.push(A);return V<i-1&&h.push("..."),i>1&&h.push(i),h});se([()=>l.productId,u],async()=>{l.productId&&await t()},{immediate:!0});async function t(){await r.fetchReviewsByProductId(l.productId,u.value,k.value)}function T(){u.value>1&&u.value--}function P(){u.value<p.value&&u.value++}function v(i){i!=="..."&&i>=1&&i<=p.value&&i!==u.value&&(u.value=i)}function d(i){if(!i)return"";const h={year:"numeric",month:"long",day:"numeric"};return new Date(i).toLocaleDateString("ru-RU",h)}function s(i){return m.isAuthenticated&&m.user&&i.user_id===m.user.id}function a(i){C("edit-review",i)}async function f(i){confirm("Вы действительно хотите удалить этот отзыв?")&&await r.deleteReview(i.id,l.productId)}function y(i){return i>=4?"var(--color-success)":i>=3?"#f8ce0b":"var(--color-error)"}function D(i){const h="★",w="☆";let V="";for(let A=1;A<=5;A++)V+=A<=i?h:w;return V}function B(i){if(i===0)return"отзывов";const h=i%10,w=i%100;return w>=11&&w<=19?"отзывов":h===1?"отзыв":h>=2&&h<=4?"отзыва":"отзывов"}return(i,h)=>(o(),n("div",xe,[$(r).loading?(o(),n("div",Se,h[0]||(h[0]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"Загрузка отзывов...",-1)]))):$(r).error?(o(),n("div",Pe,[e("p",null,_($(r).error),1),e("button",{onClick:t,class:"btn btn-outline"},"Попробовать снова")])):(o(),n("div",Ve,[e("div",Ae,[h[2]||(h[2]=e("h2",{class:"reviews-title"},"Отзывы о товаре",-1)),$(r).reviews.length>0?(o(),n("div",Fe,[e("div",Te,[e("span",{class:"rating-number",style:q({color:y($(r).averageRating)})},_(typeof $(r).averageRating=="number"?$(r).averageRating.toFixed(1):"0.0"),5),e("span",{class:"rating-stars",style:q({color:y($(r).averageRating)})},_(D(Math.round($(r).averageRating||0))),5)]),e("p",De,_($(r).totalReviews)+" "+_(B($(r).totalReviews)),1)])):(o(),n("div",Ie,h[1]||(h[1]=[e("span",{class:"no-rating"},"Нет оценок",-1)])))]),$(r).reviews.length===0?(o(),n("div",Ee,h[3]||(h[3]=[e("p",null,"У этого товара пока нет отзывов. Будьте первым, кто оставит отзыв!",-1)]))):(o(),n("div",je,[(o(!0),n(E,null,j($(r).reviews,w=>(o(),n("div",{key:w.id,class:"review-card"},[e("div",Be,[e("div",Ne,[e("span",ze,_(w.full_name||"Пользователь"),1),e("span",qe,_(d(w.created_at)),1)]),e("div",{class:"review-rating",style:q({color:y(w.rating)})},_(D(w.rating)),5)]),e("div",Me,[w.comment&&w.comment.Valid?(o(),n("p",Le,_(w.comment.String),1)):(o(),n("p",Ue,"Пользователь не оставил комментарий"))]),s(w)?(o(),n("div",Oe,[e("button",{onClick:V=>a(w),class:"btn btn-sm btn-outline review-action-btn"}," Редактировать ",8,Ge),e("button",{onClick:V=>f(w),class:"btn btn-sm btn-outline review-action-btn delete-btn"}," Удалить ",8,Je)])):F("",!0)]))),128))])),p.value>1?(o(),n("div",Qe,[e("button",{onClick:T,class:"pagination-btn",disabled:u.value===1}," « ",8,He),e("div",Ke,[(o(!0),n(E,null,j(x.value,w=>(o(),n("button",{key:w,onClick:V=>v(w),class:U(["pagination-page",{active:w===u.value,disabled:w==="..."}])},_(w),11,We))),128))]),e("button",{onClick:P,class:"pagination-btn",disabled:u.value===p.value}," » ",8,Xe)])):F("",!0)]))]))}},Ze=L(Ye,[["__scopeId","data-v-429459b4"]]),et={class:"product-view"},tt={class:"container"},st={key:0,class:"loading-container"},at={key:1,class:"error-message"},ot={key:2,class:"product-details"},nt={class:"product-image-container"},it=["src","alt"],rt={class:"product-info"},lt={class:"product-name"},ct={class:"product-meta"},ut={key:0,class:"product-category"},vt={key:1,class:"product-stock in-stock"},dt={key:2,class:"product-stock out-of-stock"},ft={class:"product-price"},wt={class:"product-description"},ht={class:"product-controls"},pt={class:"quantity-control"},_t=["disabled"],gt=["max","disabled"],mt=["disabled"],yt=["disabled"],bt={key:0},kt={key:1},Rt={key:2},$t=["disabled"],Ct={key:0,class:"product-characteristics"},xt={class:"characteristics-list"},St={class:"characteristic-name"},Pt={class:"characteristic-value"},Vt={key:0,class:"product-reviews"},At={key:0,class:"reviews-actions"},Ft={key:1,class:"review-status-message"},Tt={__name:"ProductView",emits:["show-message"],setup(b,{emit:S}){const l=S,C=re(),r=ve(),m=ae(),u=oe(),k=ne(),p=M(),x=O(),t=g(null),T=g(!0),P=g(null),v=g(1),d=g(!1),s=g(!1),a=g(null),f=g({canReview:!1,reason:null}),y=I(()=>{if(!t.value)return"";const c=m.categories.find(R=>R.id===t.value.category_id);return c?c.name:""}),D=I(()=>{if(!t.value)return!1;console.log("Вычисление isFavorite для продукта в ProductView:",t.value.id);const c=k.isInFavorites(t.value.id);return console.log("Результат вычисления isFavorite в ProductView:",c),c}),B=I(()=>{if(!t.value)return!1;console.log("Вычисление isInCart для продукта в ProductView:",t.value.id);const c=u.isInCart(t.value.id);return console.log("Результат вычисления isInCart в ProductView:",c),c});ie(async()=>{console.log("ProductView: onMounted вызван");try{await m.fetchCategories(),console.log("ProductView: категории загружены"),p.isAuthenticated&&(console.log("ProductView: пользователь авторизован, загружаем корзину и избранное"),await u.fetchCartItems(),await k.fetchFavorites(),console.log("ProductView: корзина и избранное загружены"));const c=C.params.id;console.log("ProductView: загружаем товар с ID:",c),t.value=await m.fetchProductById(c),console.log("ProductView: товар загружен:",t.value),t.value?await i():P.value="Товар не найден"}catch(c){P.value=c.message||"Произошла ошибка при загрузке товара",console.error("ProductView: ошибка при загрузке данных:",c)}finally{T.value=!1,console.log("ProductView: загрузка завершена")}});async function i(){!t.value||!p.isAuthenticated||(f.value=await x.checkCanReview(t.value.id),console.log("Статус возможности оставить отзыв:",f.value))}function h(){v.value>1&&v.value--}function w(){t.value&&t.value.stock>0&&(v.value<t.value.stock?v.value++:l("show-message",{type:"warning",text:`Доступно только ${t.value.stock} шт.`}))}async function V(){if(t.value){if(!p.isAuthenticated){l("show-message",{type:"error",text:"Для добавления товара в корзину необходимо авторизоваться"}),r.push("/login");return}d.value=!0;try{const c=await u.addToCart({...t.value,quantity:v.value});c.success?l("show-message",{type:"success",text:`Товар добавлен в корзину (${v.value} шт.)`}):l("show-message",{type:"error",text:c.error||"Ошибка при добавлении в корзину"})}catch(c){console.error("Ошибка при добавлении в корзину:",c),l("show-message",{type:"error",text:"Произошла ошибка при добавлении товара в корзину"})}finally{d.value=!1}}}async function A(){if(t.value){if(!p.isAuthenticated){l("show-message",{type:"error",text:"Для добавления в избранное необходимо авторизоваться"}),r.push("/login");return}d.value=!0;try{let c;if(D.value?c=await k.removeFromFavorites(t.value.id):c=await k.addToFavorites(t.value),c.success){const R=D.value?"добавлен в":"удален из";l("show-message",{type:"success",text:`Товар ${R} избранное`})}else l("show-message",{type:"error",text:c.error||"Ошибка при обновлении избранного"})}catch(c){console.error("Ошибка при работе с избранным:",c),l("show-message",{type:"error",text:"Произошла ошибка при обновлении избранного"})}finally{d.value=!1}}}function N(){if(!p.isAuthenticated){l("show-message",{type:"error",text:"Для добавления отзыва необходимо авторизоваться"}),r.push("/login");return}if(!f.value.canReview){l("show-message",{type:"error",text:f.value.reason});return}s.value=!0,a.value=null}function K(c){s.value=!1,l("show-message",{type:"success",text:"Ваш отзыв успешно добавлен"}),i()}function W(c){s.value=!1,a.value=null,l("show-message",{type:"success",text:"Ваш отзыв успешно обновлен"})}function X(c){a.value=c,s.value=!0}function Y(){s.value=!1,a.value=null}return(c,R)=>{const Z=ce("RouterLink");return o(),n("div",et,[e("div",tt,[T.value?(o(),n("div",st,R[1]||(R[1]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"Загрузка информации о товаре...",-1)]))):P.value?(o(),n("div",at,[e("p",null,_(P.value),1),J(Z,{to:"/",class:"btn btn-primary"},{default:le(()=>R[2]||(R[2]=[de("Вернуться на главную")])),_:1})])):t.value?(o(),n("div",ot,[e("div",nt,[e("img",{src:t.value.image,alt:t.value.name,class:"product-image"},null,8,it)]),e("div",rt,[e("h1",lt,_(t.value.name),1),e("div",ct,[y.value?(o(),n("span",ut,_(y.value),1)):F("",!0),t.value.inStock?(o(),n("span",vt,"В наличии ("+_(t.value.stock)+" шт.)",1)):(o(),n("span",dt,"Нет в наличии"))]),e("p",ft,_(t.value.price)+" ₽",1),e("div",wt,[e("p",null,_(t.value.description),1)]),e("div",ht,[e("div",pt,[e("button",{onClick:h,class:"quantity-btn",disabled:!t.value.inStock||d.value},"-",8,_t),Q(e("input",{type:"number","onUpdate:modelValue":R[0]||(R[0]=z=>v.value=z),min:"1",max:t.value.stock,class:"quantity-input",disabled:!t.value.inStock||d.value},null,8,gt),[[H,v.value]]),e("button",{onClick:w,class:"quantity-btn",disabled:!t.value.inStock||d.value},"+",8,mt)]),e("button",{onClick:V,class:"btn btn-accent add-to-cart-btn",disabled:!t.value.inStock||d.value},[d.value?(o(),n("span",bt,"Загрузка...")):B.value?(o(),n("span",kt,"Добавить еще")):(o(),n("span",Rt,"В корзину"))],8,yt),e("button",{onClick:A,class:U(["btn btn-icon favorite-btn",{"is-favorite":D.value}]),disabled:d.value},R[3]||(R[3]=[e("span",{class:"favorite-icon"},"♥",-1)]),10,$t)]),t.value.characteristics?(o(),n("div",Ct,[R[4]||(R[4]=e("h3",null,"Характеристики",-1)),e("ul",xt,[(o(!0),n(E,null,j(t.value.characteristics,(z,G)=>(o(),n("li",{key:G,class:"characteristic-item"},[e("span",St,_(G)+":",1),e("span",Pt,_(z),1)]))),128))])])):F("",!0)]),t.value?(o(),n("div",Vt,[$(p).isAuthenticated?(o(),n("div",At,[f.value.canReview?(o(),n("button",{key:0,onClick:N,class:"btn btn-primary"}," Оставить отзыв ")):f.value.reason?(o(),n("p",Ft,_(f.value.reason),1)):F("",!0)])):F("",!0),s.value?(o(),ue(Ce,{key:1,"product-id":t.value.id,"existing-review":a.value,onReviewSubmitted:K,onReviewUpdated:W,onCancel:Y},null,8,["product-id","existing-review"])):F("",!0),J(Ze,{"product-id":t.value.id,onEditReview:X},null,8,["product-id"])])):F("",!0)])):F("",!0)])])}}},It=L(Tt,[["__scopeId","data-v-5937b568"]]);export{It as default};
